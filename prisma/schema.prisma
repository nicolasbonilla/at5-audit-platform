// Prisma Schema for AT5 Audit Platform
// Based on ISO/IEC/IEEE 29119 and ISTQB standards

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USUARIOS Y ORGANIZACIONES
// ============================================================================

model Organization {
  id          String   @id @default(cuid())
  name        String
  description String?
  logo        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]
  testPlans   TestPlan[]
}

model User {
  id              String         @id @default(cuid())
  email           String         @unique
  emailVerified   DateTime?
  password        String         // Hashed with bcrypt
  name            String
  avatar          String?
  role            UserRole       @default(VIEWER)
  isActive        Boolean        @default(true)
  lastLogin       DateTime?
  failedAttempts  Int            @default(0)
  lockedUntil     DateTime?
  organizationId  String
  organization    Organization   @relation(fields: [organizationId], references: [id])
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relaciones
  auditSessions   AuditSession[] @relation("SessionAuditor")
  executedTests   TestExecution[]
  signatures      Signature[]
  auditLogs       AuditLog[]
  comments        Comment[]
  sessions        Session[]
}

enum UserRole {
  ADMIN
  LEAD_AUDITOR
  AUDITOR
  REVIEWER
  VIEWER
}

// ============================================================================
// SESIONES DE AUTENTICACIÃ“N
// ============================================================================

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires      DateTime
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  email     String
  expires   DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
}

// ============================================================================
// PLANES DE PRUEBA (ISO/IEC/IEEE 29119-3)
// ============================================================================

model TestPlan {
  id              String         @id @default(cuid())
  title           String
  version         String         @default("1.0.0")
  description     String?
  scope           String?
  objectives      String?
  testStrategy    String?
  entryExitCriteria String?
  organizationId  String
  organization    Organization   @relation(fields: [organizationId], references: [id])
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relaciones
  testSuites      TestSuite[]
  auditSessions   AuditSession[]
}

model TestSuite {
  id          String     @id @default(cuid())
  name        String
  description String?
  category    String
  order       Int        @default(0)
  testPlanId  String
  testPlan    TestPlan   @relation(fields: [testPlanId], references: [id], onDelete: Cascade)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relaciones
  testCases   TestCase[]
}

model TestCase {
  id              String          @id @default(cuid())
  code            String          // Ej: TC-PRJ-001
  name            String
  description     String?
  preconditions   String?
  steps           String          // JSON array of steps
  expectedResult  String
  priority        Priority        @default(MEDIUM)
  testType        TestType        @default(FUNCTIONAL)
  estimatedTime   Int?            // En minutos
  testSuiteId     String
  testSuite       TestSuite       @relation(fields: [testSuiteId], references: [id], onDelete: Cascade)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relaciones
  executions      TestExecution[]
}

enum Priority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum TestType {
  FUNCTIONAL
  INTEGRATION
  PERFORMANCE
  SECURITY
  USABILITY
  REGRESSION
}

// ============================================================================
// SESIONES DE AUDITORIA
// ============================================================================

model AuditSession {
  id              String          @id @default(cuid())
  name            String
  description     String?
  status          SessionStatus   @default(DRAFT)
  startDate       DateTime?
  endDate         DateTime?
  auditorId       String
  auditor         User            @relation("SessionAuditor", fields: [auditorId], references: [id])
  testPlanId      String
  testPlan        TestPlan        @relation(fields: [testPlanId], references: [id])
  progress        Float           @default(0)
  passedCount     Int             @default(0)
  failedCount     Int             @default(0)
  blockedCount    Int             @default(0)
  skippedCount    Int             @default(0)
  totalCount      Int             @default(0)
  blockchainHash  String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relaciones
  executions      TestExecution[]
  signatures      Signature[]
  reports         Report[]
  auditLogs       AuditLog[]
  comments        Comment[]
}

enum SessionStatus {
  DRAFT
  IN_PROGRESS
  REVIEW
  APPROVED
  REJECTED
  ARCHIVED
}

// ============================================================================
// EJECUCION DE PRUEBAS
// ============================================================================

model TestExecution {
  id              String          @id @default(cuid())
  status          ExecutionStatus @default(NOT_STARTED)
  actualResult    String?
  comments        String?
  startTime       DateTime?
  endTime         DateTime?
  duration        Int?            // En segundos
  executedById    String
  executedBy      User            @relation(fields: [executedById], references: [id])
  testCaseId      String
  testCase        TestCase        @relation(fields: [testCaseId], references: [id])
  sessionId       String
  session         AuditSession    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  stepsCompleted  String?         // JSON array of completed step indices
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relaciones
  evidences       Evidence[]
}

enum ExecutionStatus {
  NOT_STARTED
  IN_PROGRESS
  PASSED
  FAILED
  BLOCKED
  SKIPPED
}

// ============================================================================
// EVIDENCIAS
// ============================================================================

model Evidence {
  id              String          @id @default(cuid())
  type            EvidenceType
  fileName        String
  filePath        String
  fileSize        Int
  mimeType        String
  hash            String          // SHA-256
  description     String?
  metadata        String?         // JSON con metadata adicional
  blockchainTx    String?
  executionId     String
  execution       TestExecution   @relation(fields: [executionId], references: [id], onDelete: Cascade)
  uploadedAt      DateTime        @default(now())
}

enum EvidenceType {
  SCREENSHOT
  LOG
  PDF
  VIDEO
  JSON
  OTHER
}

// ============================================================================
// FIRMAS Y APROBACIONES
// ============================================================================

model Signature {
  id              String          @id @default(cuid())
  role            String          // Rol del firmante
  signatureData   String?         // Base64 de firma visual
  certificate     String?         // Certificado digital
  ipAddress       String?
  userAgent       String?
  blockchainTx    String?
  valid           Boolean         @default(true)
  userId          String
  user            User            @relation(fields: [userId], references: [id])
  sessionId       String
  session         AuditSession    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  signedAt        DateTime        @default(now())
}

// ============================================================================
// REPORTES
// ============================================================================

model Report {
  id              String          @id @default(cuid())
  type            ReportType
  format          ReportFormat
  fileName        String
  filePath        String
  fileSize        Int
  hash            String
  sessionId       String
  session         AuditSession    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  generatedAt     DateTime        @default(now())
}

enum ReportType {
  EXECUTIVE_SUMMARY
  DETAILED
  DEFECTS
  METRICS
}

enum ReportFormat {
  PDF
  DOCX
  HTML
  JSON
  LATEX
}

// ============================================================================
// AUDIT LOG (Inmutable)
// ============================================================================

model AuditLog {
  id              String          @id @default(cuid())
  action          String          // CREATE, UPDATE, DELETE, EXECUTE, SIGN, EXPORT, LOGIN, LOGOUT, etc.
  entity          String          // Entity type affected
  entityId        String
  oldValue        String?         // JSON
  newValue        String?         // JSON
  details         String?         // Human readable description
  ipAddress       String?
  userAgent       String?
  hash            String?         // SHA-256 hash for integrity verification
  previousHash    String?         // Hash del registro anterior (cadena de integridad)
  userId          String
  user            User            @relation(fields: [userId], references: [id])
  sessionId       String?
  session         AuditSession?   @relation(fields: [sessionId], references: [id])
  timestamp       DateTime        @default(now())

  @@index([userId])
  @@index([sessionId])
  @@index([entity, entityId])
  @@index([timestamp])
}

// ============================================================================
// COMENTARIOS
// ============================================================================

model Comment {
  id              String          @id @default(cuid())
  content         String
  entityType      String
  entityId        String
  userId          String
  user            User            @relation(fields: [userId], references: [id])
  sessionId       String
  session         AuditSession    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}
